<html>
  <head>
    <title>Transact Status</title>
  </head>
  <body>
    <table>
      <thead><tr><th>At End Of</th></th><th>Total</th><th>Change</th></tr></thead>
      <tbody id="table-body"></tbody>
    </table>

    <h3>Add New Transact Entry</h3>

    <form id="entry-form">
 
      <label for="at-end-of">At End Of:</label>
      <input type="text" id="at-end-of" name="atendof" required>

      <label for="total">Total:</label>
      <input type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" id="total" name="total" required>

      <button type="submit">Submit</button>

    </form>

    <canvas id="line-chart"></canvas>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>

      let today = new Date();
      let yesterday = new Date(today);
      yesterday.setDate(today.getDate() - 1);

      let dd = yesterday.getDate();
      let mm = yesterday.getMonth() + 1; // Months are zero-based
      let yyyy = yesterday.getFullYear();

      dd = dd < 10 ? '0' + dd : dd;
      mm = mm < 10 ? '0' + mm : mm;

      let formattedDate = dd + '/' + mm + '/' + yyyy;

      document.getElementById('at-end-of').value = formattedDate;

      const entryForm = document.getElementById('entry-form');
      const tableBody = document.getElementById('table-body');
      const lineChartCtx = document.getElementById('line-chart').getContext('2d');
  
      let prevTotal = 0;
      let chart; // Holds Chart.js instance

      async function fetchDataAndUpdateUI() {
        const response = await fetch('https://sheetdb.io/api/v1/73wrvfbt1oosx');
        const data = await response.json();

        tableBody.innerHTML = '';
        let index = 0;
        data.forEach(row => {
          if (index >= data.length - 10) {
            tableBody.innerHTML += `<tr><td align='right'>${row["AtEndOf"]}</td><td align='right'>${row["Total"]}</td><td align='right'>${row["WeeklyChange"]}</td></tr>`;
            prevTotal = row["Total"];
          }
          index = index + 1;
        }); //data.forEach

  // Prepare chart data
        const atEndOf = data.map(row => row["AtEndOf"]);
        const total = data.map(row => row["Total"]);

        if (chart) {
          chart.data.labels = atEndOf;
          chart.data.datasets[0].data = total;
          chart.update();
        } else {
          chart = new Chart(lineChartCtx, {
            type: 'line',
            data: {
              labels: atEndOf,
              datasets: [{
                label: 'Total',
                data: total,
                borderColor: 'green',
                fill: false
              }] //datasets
            } //data
          }); //new Chart
        } //if (chart)
      } //async function fetchDataAndUpdateUI

      entryForm.onsubmit = async (e) => {
        e.preventDefault();
        const AtEndOf = entryForm.atendof.value;
        const Total = entryForm.total.value;
        const WeeklyChange = entryForm.total.value - prevTotal;

        await fetch('https://sheetdb.io/api/v1/73wrvfbt1oosx', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify([{ AtEndOf, Total, WeeklyChange }])
        }); //await fetch

        entryForm.reset();  // Clear form inputs
    
        fetchDataAndUpdateUI();  // Refresh table and chart
    
      }; //entryForm.onsubmit

// Initial data load
      fetchDataAndUpdateUI();
  
    </script>
    
  </body>
  
</html>
